<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∞–∫—Å–æ–ø–∞—Ä–∫ - –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 4px solid #667eea;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .tab:hover {
            background: #f0f2f5;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .content-panel {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 8px;
        }

        select, input, button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95em;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 600;
        }

        button:hover {
            background: #5a67d8;
        }

        button.secondary {
            background: #48bb78;
        }

        button.secondary:hover {
            background: #38a169;
        }

        button.warning {
            background: #f6ad55;
        }

        button.warning:hover {
            background: #ed8936;
        }

        button.danger {
            background: #fc8181;
        }

        button.danger:hover {
            background: #f56565;
        }

        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #555;
            border-bottom: 2px solid #ddd;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-FREE { background: #c6f6d5; color: #22543d; }
        .status-BUSY { background: #fed7d7; color: #742a2a; }
        .status-REPAIR { background: #feebc8; color: #744210; }

        .rating-high { color: #38a169; font-weight: 600; }
        .rating-low { color: #e53e3e; font-weight: 600; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #666;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fed7d7;
            color: #742a2a;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .info-card {
            background: #ebf8ff;
            border-left: 4px solid #4299e1;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-buttons button {
            padding: 6px 12px;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                width: 100%;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöï –¢–∞–∫—Å–æ–ø–∞—Ä–∫ - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–Ω–µ–ª—å</h1>
            <div class="subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–ø–∞—Ä–∫–æ–º –∏ –≤–æ–¥–∏—Ç–µ–ª—è–º–∏</div>
        </header>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats-grid" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalCars">-</div>
                <div class="stat-label">–í—Å–µ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="freeCars">-</div>
                <div class="stat-label">–°–≤–æ–±–æ–¥–Ω—ã</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="busyCars">-</div>
                <div class="stat-label">–ó–∞–Ω—è—Ç—ã</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="repairCars">-</div>
                <div class="stat-label">–í —Ä–µ–º–æ–Ω—Ç–µ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalDrivers">-</div>
                <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgRating">-</div>
                <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π —Ä–µ–π—Ç–∏–Ω–≥</div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="tabs">
            <button class="tab active" data-tab="cars">üöó –ê–≤—Ç–æ–º–æ–±–∏–ª–∏</button>
            <button class="tab" data-tab="drivers">üë®‚Äç‚úàÔ∏è –í–æ–¥–∏—Ç–µ–ª–∏</button>
            <button class="tab" data-tab="repair">üîß –í —Ä–µ–º–æ–Ω—Ç–µ</button>
            <button class="tab" data-tab="low-rating">‚ö†Ô∏è –ù–∏–∑–∫–∏–π —Ä–µ–π—Ç–∏–Ω–≥</button>
            <button class="tab" data-tab="add-car">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ</button>
            <button class="tab" data-tab="add-driver">üë§ –î–æ–±–∞–≤–∏—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è</button>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="notifications"></div>

        <!-- –ö–æ–Ω—Ç–µ–Ω—Ç–Ω—ã–µ –ø–∞–Ω–µ–ª–∏ -->
        <div id="content"></div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const API_URL = 'http://localhost:8000';
        const LOW_RATING_THRESHOLD = 4.0;

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let currentTab = 'cars';
        let carsData = [];
        let driversData = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', async () => {
            await loadAllData();
            setupEventListeners();
            renderTab(currentTab);
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        async function loadAllData() {
            try {
                showLoading();
                const [cars, drivers] = await Promise.all([
                    fetch(`${API_URL}/cars`).then(res => res.json()),
                    fetch(`${API_URL}/drivers?only_active=true`).then(res => res.json())
                ]);
                carsData = cars;
                driversData = drivers;
                updateStats();
                hideLoading();
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
                hideLoading();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats() {
            document.getElementById('totalCars').textContent = carsData.length;
            document.getElementById('freeCars').textContent = carsData.filter(c => c.status === 'FREE').length;
            document.getElementById('busyCars').textContent = carsData.filter(c => c.status === 'BUSY').length;
            document.getElementById('repairCars').textContent = carsData.filter(c => c.status === 'REPAIR').length;
            document.getElementById('totalDrivers').textContent = driversData.length;
            
            const avg = driversData.reduce((acc, d) => acc + d.rating, 0) / driversData.length || 0;
            document.getElementById('avgRating').textContent = avg.toFixed(2);
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTab = tab.dataset.tab;
                    renderTab(currentTab);
                });
            });
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∫–ª–∞–¥–æ–∫
        function renderTab(tab) {
            switch(tab) {
                case 'cars':
                    renderCarsTab();
                    break;
                case 'drivers':
                    renderDriversTab();
                    break;
                case 'repair':
                    renderRepairTab();
                    break;
                case 'low-rating':
                    renderLowRatingTab();
                    break;
                case 'add-car':
                    renderAddCarForm();
                    break;
                case 'add-driver':
                    renderAddDriverForm();
                    break;
            }
        }

        // –í–∫–ª–∞–¥–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
        function renderCarsTab() {
            const filterHtml = `
                <div class="filters">
                    <div class="filter-group">
                        <label>–°—Ç–∞—Ç—É—Å:</label>
                        <select id="carStatusFilter" onchange="applyCarFilters()">
                            <option value="all">–í—Å–µ</option>
                            <option value="FREE">–°–≤–æ–±–æ–¥–Ω—ã</option>
                            <option value="BUSY">–ó–∞–Ω—è—Ç—ã</option>
                            <option value="REPAIR">–í —Ä–µ–º–æ–Ω—Ç–µ</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ:</label>
                        <input type="number" id="maxDistance" placeholder="–∫–º" onchange="applyCarFilters()">
                    </div>
                    <button onclick="refreshData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            `;

            const tableHtml = `
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–ì–æ—Å–Ω–æ–º–µ—Ä</th>
                                <th>–ú–∞—Ä–∫–∞</th>
                                <th>–¶–≤–µ—Ç</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ</th>
                                <th>–í–æ–¥–∏—Ç–µ–ª—å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="carsTableBody">
                            ${renderCarsRows()}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('content').innerHTML = filterHtml + tableHtml;
        }

        function renderCarsRows() {
            const statusFilter = document.getElementById('carStatusFilter')?.value || 'all';
            const maxDistance = parseFloat(document.getElementById('maxDistance')?.value);
            
            let filteredCars = carsData;
            
            if (statusFilter !== 'all') {
                filteredCars = filteredCars.filter(c => c.status === statusFilter);
            }
            
            if (!isNaN(maxDistance)) {
                filteredCars = filteredCars.filter(c => c.distance <= maxDistance);
            }

            return filteredCars.map(car => `
                <tr>
                    <td>${car.id}</td>
                    <td><strong>${car.license_plate}</strong></td>
                    <td>${car.brand}</td>
                    <td>${car.color}</td>
                    <td><span class="status-badge status-${car.status}">${car.status}</span></td>
                    <td>${car.distance} –∫–º</td>
                    <td>${car.driver ? car.driver.full_name.split(' ')[0] : '‚Äî'}</td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="editCar(${car.id})" class="secondary">‚úèÔ∏è</button>
                            <button onclick="changeCarStatus(${car.id}, 'FREE')" class="${car.status === 'FREE' ? 'warning' : 'secondary'}">üöñ</button>
                            <button onclick="changeCarStatus(${car.id}, 'BUSY')" class="${car.status === 'BUSY' ? 'warning' : 'secondary'}">üèÉ</button>
                            <button onclick="changeCarStatus(${car.id}, 'REPAIR')" class="${car.status === 'REPAIR' ? 'warning' : 'secondary'}">üîß</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // –í–∫–ª–∞–¥–∫–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–π
        function renderDriversTab() {
            const filterHtml = `
                <div class="filters">
                    <div class="filter-group">
                        <label>–ú–∏–Ω. —Ä–µ–π—Ç–∏–Ω–≥:</label>
                        <input type="number" id="minRating" min="0" max="5" step="0.1" placeholder="4.0" onchange="applyDriverFilters()">
                    </div>
                    <button onclick="refreshData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
                </div>
            `;

            const tableHtml = `
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>–§–ò–û</th>
                                <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                <th>–†–µ–π—Ç–∏–Ω–≥</th>
                                <th>–ê–≤—Ç–æ–º–æ–±–∏–ª—å</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="driversTableBody">
                            ${renderDriversRows()}
                        </tbody>
                    </table>
                </div>
            `;

            document.getElementById('content').innerHTML = filterHtml + tableHtml;
        }

        function renderDriversRows() {
            const minRating = parseFloat(document.getElementById('minRating')?.value);
            
            let filteredDrivers = driversData;
            
            if (!isNaN(minRating)) {
                filteredDrivers = filteredDrivers.filter(d => d.rating >= minRating);
            }

            return filteredDrivers.map(driver => `
                <tr>
                    <td>${driver.id}</td>
                    <td><strong>${driver.full_name}</strong></td>
                    <td>${driver.phone}</td>
                    <td class="${driver.rating < 4.0 ? 'rating-low' : 'rating-high'}">
                        ${driver.rating.toFixed(2)} ‚≠ê
                    </td>
                    <td>${driver.car ? driver.car.license_plate : '‚Äî'}</td>
                    <td>${driver.is_active ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="editDriver(${driver.id})" class="secondary">‚úèÔ∏è</button>
                            ${driver.is_active ? 
                                `<button onclick="toggleDriverStatus(${driver.id}, false)" class="warning">‚ùå</button>` :
                                `<button onclick="toggleDriverStatus(${driver.id}, true)" class="secondary">‚úÖ</button>`
                            }
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // –í–∫–ª–∞–¥–∫–∞ –º–∞—à–∏–Ω –≤ —Ä–µ–º–æ–Ω—Ç–µ
        async function renderRepairTab() {
            try {
                const response = await fetch(`${API_URL}/cars/in-repair`);
                const repairCars = await response.json();
                
                const html = `
                    <div class="info-card">
                        üöß –°–µ–π—á–∞—Å –≤ —Ä–µ–º–æ–Ω—Ç–µ ${repairCars.length} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>–ì–æ—Å–Ω–æ–º–µ—Ä</th>
                                    <th>–ú–∞—Ä–∫–∞</th>
                                    <th>–¶–≤–µ—Ç</th>
                                    <th>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –ø–∞—Ä–∫–∞</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${repairCars.map(car => `
                                    <tr>
                                        <td>${car.id}</td>
                                        <td><strong>${car.license_plate}</strong></td>
                                        <td>${car.brand}</td>
                                        <td>${car.color}</td>
                                        <td>${car.distance} –∫–º</td>
                                        <td>
                                            <button onclick="changeCarStatus(${car.id}, 'FREE')" class="secondary">
                                                üöñ –í–µ—Ä–Ω—É—Ç—å –≤ –ø–∞—Ä–∫
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('content').innerHTML = html;
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }

        // –í–∫–ª–∞–¥–∫–∞ –Ω–∏–∑–∫–æ–≥–æ —Ä–µ–π—Ç–∏–Ω–≥–∞
        async function renderLowRatingTab() {
            try {
                const response = await fetch(`${API_URL}/drivers/low-rating?threshold=${LOW_RATING_THRESHOLD}`);
                const lowRatingDrivers = await response.json();
                
                const html = `
                    <div class="info-card">
                        ‚ö†Ô∏è ${lowRatingDrivers.length} –≤–æ–¥–∏—Ç–µ–ª–µ–π –∏–º–µ—é—Ç —Ä–µ–π—Ç–∏–Ω–≥ –Ω–∏–∂–µ ${LOW_RATING_THRESHOLD}
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>–§–ò–û</th>
                                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                    <th>–†–µ–π—Ç–∏–Ω–≥</th>
                                    <th>–ê–≤—Ç–æ–º–æ–±–∏–ª—å</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${lowRatingDrivers.map(driver => `
                                    <tr>
                                        <td>${driver.id}</td>
                                        <td><strong>${driver.full_name}</strong></td>
                                        <td>${driver.phone}</td>
                                        <td class="rating-low">${driver.rating.toFixed(2)} ‚≠ê</td>
                                        <td>${driver.car_id ? '–ü—Ä–∏–≤—è–∑–∞–Ω' : '–ù–µ—Ç –∞–≤—Ç–æ'}</td>
                                        <td>
                                            <button onclick="editDriver(${driver.id})" class="secondary">
                                                ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                document.getElementById('content').innerHTML = html;
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
            }
        }

        // –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ–º–æ–±–∏–ª—è
        function renderAddCarForm() {
            const html = `
                <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å</h2>
                <div style="max-width: 500px;">
                    <div class="form-group">
                        <label>–ì–æ—Å–Ω–æ–º–µ—Ä *</label>
                        <input type="text" id="carLicense" placeholder="–ê123–ë–í777" required>
                    </div>
                    <div class="form-group">
                        <label>–ú–∞—Ä–∫–∞ *</label>
                        <input type="text" id="carBrand" placeholder="Toyota" required>
                    </div>
                    <div class="form-group">
                        <label>–¶–≤–µ—Ç *</label>
                        <input type="text" id="carColor" placeholder="–ë–µ–ª—ã–π" required>
                    </div>
                    <div class="form-group">
                        <label>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –ø–∞—Ä–∫–∞ (–∫–º) *</label>
                        <input type="number" id="carDistance" min="0.1" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label>–°—Ç–∞—Ç—É—Å</label>
                        <select id="carStatus">
                            <option value="FREE">–°–≤–æ–±–æ–¥–µ–Ω</option>
                            <option value="BUSY">–ó–∞–Ω—è—Ç</option>
                            <option value="REPAIR">–í —Ä–µ–º–æ–Ω—Ç–µ</option>
                        </select>
                    </div>
                    <button onclick="addCar()" class="secondary" style="width: 100%;">‚úÖ –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å</button>
                </div>
            `;
            
            document.getElementById('content').innerHTML = html;
        }

        // –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—è
        function renderAddDriverForm() {
            const freeCars = carsData.filter(c => c.status === 'FREE' && !c.driver);
            
            const html = `
                <h2>üë§ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è</h2>
                <div style="max-width: 500px;">
                    <div class="form-group">
                        <label>–§–ò–û *</label>
                        <input type="text" id="driverName" placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á" required>
                    </div>
                    <div class="form-group">
                        <label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                        <input type="text" id="driverPhone" placeholder="+79001234567" required>
                    </div>
                    <div class="form-group">
                        <label>–†–µ–π—Ç–∏–Ω–≥</label>
                        <input type="number" id="driverRating" min="0" max="5" step="0.1" value="5.0">
                    </div>
                    <div class="form-group">
                        <label>–ê–≤—Ç–æ–º–æ–±–∏–ª—å</label>
                        <select id="driverCar">
                            <option value="">–ë–µ–∑ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</option>
                            ${freeCars.map(car => `
                                <option value="${car.id}">${car.license_plate} - ${car.brand}</option>
                            `).join('')}
                        </select>
                    </div>
                    <button onclick="addDriver()" class="secondary" style="width: 100%;">‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è</button>
                </div>
            `;
            
            document.getElementById('content').innerHTML = html;
        }

        // API —Ñ—É–Ω–∫—Ü–∏–∏
        async function changeCarStatus(carId, newStatus) {
            try {
                const response = await fetch(`${API_URL}/cars/${carId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    showNotification(`–°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ ${newStatus}`, 'success');
                    await refreshData();
                    renderTab(currentTab);
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                }
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function addCar() {
            const carData = {
                license_plate: document.getElementById('carLicense').value,
                brand: document.getElementById('carBrand').value,
                color: document.getElementById('carColor').value,
                distance: parseFloat(document.getElementById('carDistance').value),
                status: document.getElementById('carStatus').value
            };

            if (!carData.license_plate || !carData.brand || !carData.color || !carData.distance) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/cars`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(carData)
                });

                if (response.ok) {
                    showNotification('–ê–≤—Ç–æ–º–æ–±–∏–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                    await refreshData();
                    currentTab = 'cars';
                    renderTab('cars');
                    document.querySelector('[data-tab="cars"]').classList.add('active');
                    document.querySelector('[data-tab="add-car"]').classList.remove('active');
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function addDriver() {
            const driverData = {
                full_name: document.getElementById('driverName').value,
                phone: document.getElementById('driverPhone').value,
                rating: parseFloat(document.getElementById('driverRating').value),
                car_id: document.getElementById('driverCar').value || null
            };

            if (!driverData.full_name || !driverData.phone) {
                showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/drivers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(driverData)
                });

                if (response.ok) {
                    showNotification('–í–æ–¥–∏—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                    await refreshData();
                    currentTab = 'drivers';
                    renderTab('drivers');
                    document.querySelector('[data-tab="drivers"]').classList.add('active');
                    document.querySelector('[data-tab="add-driver"]').classList.remove('active');
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function editCar(carId) {
            const car = carsData.find(c => c.id === carId);
            
            const formHtml = `
                <div class="form-group">
                    <label>–ì–æ—Å–Ω–æ–º–µ—Ä</label>
                    <input type="text" id="editLicense" value="${car.license_plate}" readonly>
                </div>
                <div class="form-group">
                    <label>–ú–∞—Ä–∫–∞</label>
                    <input type="text" id="editBrand" value="${car.brand}" readonly>
                </div>
                <div class="form-group">
                    <label>–¶–≤–µ—Ç</label>
                    <input type="text" id="editColor" value="${car.color}">
                </div>
                <div class="form-group">
                    <label>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –ø–∞—Ä–∫–∞ (–∫–º)</label>
                    <input type="number" id="editDistance" value="${car.distance}" min="0.1" step="0.1">
                </div>
                <div class="form-group">
                    <label>–°—Ç–∞—Ç—É—Å</label>
                    <select id="editStatus">
                        <option value="FREE" ${car.status === 'FREE' ? 'selected' : ''}>–°–≤–æ–±–æ–¥–µ–Ω</option>
                        <option value="BUSY" ${car.status === 'BUSY' ? 'selected' : ''}>–ó–∞–Ω—è—Ç</option>
                        <option value="REPAIR" ${car.status === 'REPAIR' ? 'selected' : ''}>–í —Ä–µ–º–æ–Ω—Ç–µ</option>
                    </select>
                </div>
                <button onclick="saveCar(${carId})" class="secondary" style="width: 100%;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            `;
            
            document.getElementById('modalTitle').textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è ${car.license_plate}`;
            document.getElementById('modalBody').innerHTML = formHtml;
            document.getElementById('editModal').classList.add('active');
        }

        async function saveCar(carId) {
            const updates = {
                color: document.getElementById('editColor').value,
                distance: parseFloat(document.getElementById('editDistance').value),
                status: document.getElementById('editStatus').value
            };

            try {
                const response = await fetch(`${API_URL}/cars/${carId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });

                if (response.ok) {
                    showNotification('–ê–≤—Ç–æ–º–æ–±–∏–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
                    closeModal();
                    await refreshData();
                    renderTab(currentTab);
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function editDriver(driverId) {
            const driver = driversData.find(d => d.id === driverId);
            const freeCars = carsData.filter(c => c.status === 'FREE' && (!c.driver || c.driver.id === driverId));
            
            const formHtml = `
                <div class="form-group">
                    <label>–§–ò–û</label>
                    <input type="text" id="editDriverName" value="${driver.full_name}">
                </div>
                <div class="form-group">
                    <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="text" id="editDriverPhone" value="${driver.phone}">
                </div>
                <div class="form-group">
                    <label>–†–µ–π—Ç–∏–Ω–≥</label>
                    <input type="number" id="editDriverRating" value="${driver.rating}" min="0" max="5" step="0.1">
                </div>
                <div class="form-group">
                    <label>–ê–≤—Ç–æ–º–æ–±–∏–ª—å</label>
                    <select id="editDriverCar">
                        <option value="">–ë–µ–∑ –∞–≤—Ç–æ–º–æ–±–∏–ª—è</option>
                        ${freeCars.map(car => `
                            <option value="${car.id}" ${driver.car_id === car.id ? 'selected' : ''}>
                                ${car.license_plate} - ${car.brand}
                            </option>
                        `).join('')}
                    </select>
                </div>
                <button onclick="saveDriver(${driver.id})" class="secondary" style="width: 100%;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            `;
            
            document.getElementById('modalTitle').textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–¥–∏—Ç–µ–ª—è ${driver.full_name}`;
            document.getElementById('modalBody').innerHTML = formHtml;
            document.getElementById('editModal').classList.add('active');
        }

        async function saveDriver(driverId) {
            const updates = {
                full_name: document.getElementById('editDriverName').value,
                phone: document.getElementById('editDriverPhone').value,
                rating: parseFloat(document.getElementById('editDriverRating').value),
                car_id: document.getElementById('editDriverCar').value || null
            };

            try {
                const response = await fetch(`${API_URL}/drivers/${driverId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });

                if (response.ok) {
                    showNotification('–í–æ–¥–∏—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
                    closeModal();
                    await refreshData();
                    renderTab(currentTab);
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        async function toggleDriverStatus(driverId, isActive) {
            try {
                const response = await fetch(`${API_URL}/drivers/${driverId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_active: isActive })
                });

                if (response.ok) {
                    showNotification(`–í–æ–¥–∏—Ç–µ–ª—å ${isActive ? '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω'}`, 'success');
                    await refreshData();
                    renderTab(currentTab);
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
                }
            } catch (error) {
                showNotification(error.message, 'error');
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        async function refreshData() {
            await loadAllData();
            renderTab(currentTab);
        }

        function applyCarFilters() {
            renderCarsTab();
        }

        function applyDriverFilters() {
            renderDriversTab();
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        function showNotification(message, type) {
            const notifications = document.getElementById('notifications');
            notifications.innerHTML = `<div class="${type}">${message}</div>`;
            setTimeout(() => {
                notifications.innerHTML = '';
            }, 5000);
        }

        function showLoading() {
            document.getElementById('content').innerHTML = '<div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        }

        function hideLoading() {
            // –£–±–∏—Ä–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
</body>
</html>